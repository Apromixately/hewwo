#!/bin/sh
# hewwo's configure script
# somewhat inspired by oksh's configure

warn() {
	echo $0: "$@"
}

Makefile() {
	cat <<EOF >Makefile
# generated by ./configure
CFLAGS = -Wall -Wextra -g -O2
LIBS = -lm
OBJS := main.o net.o xdg.o linenoise/linenoise.o
BINDIR = $PREFIX/bin
LUADIR = $PREFIX/share/hewwo/edge

hewwo: \$(OBJS) lua/liblua.a
	\$(CC) \$(LDFLAGS) -o \$@ \$^ \$(LIBS)

lua/liblua.a:
	cd lua; make liblua.a

.PHONY: clean
clean:
	rm -f hewwo \$(OBJS)
EOF
	cat <<EOF >>Makefile

.PHONY: install uninstall
install: hewwo
	install -d \${DESTDIR}\${BINDIR}
	install -d \${DESTDIR}\${LUADIR}
	install -c hewwo \${DESTDIR}\${BINDIR}
	install -c *.lua \${DESTDIR}\${LUADIR}

uninstall:
	rm -f \${DESTDIR}\${BINDIR}/hewwo
	@echo Leaving behind \${DESTDIR}\${LUADIR}
	@echo If you don\\'t have any local changes there, feel free to rm -rf that.
EOF

	cat <<EOF >config.h
/* generated by ./configure */
#define LUADIR_LOCAL "/hewwo/edge/"
#define LUADIR_GLOBAL "$PREFIX/share/hewwo/edge/"
EOF
}

help() {
	cat <<EOF
Usage: ./configure [options]
Options:
  --help or -h        Display this help message
  --prefix=PREFIX     Prepare for installation in PREFIX [$PREFIX]
EOF
}


PREFIX="${PREFIX:-/usr/local}"
task=Makefile

for opt
do
	case "$opt" in
		--prefix=*)
			PREFIX=${opt#*=}
			;;
		--help|-h)
			task=help
			;;
		*)
			warn "unknown option: $opt"
			;;
	esac
done

$task
